const TelegramBot = require('node-telegram-bot-api');

const token = process.env.TELEGRAM_TOKEN;
const MODE = process.env.MODE || 'real'; // 'test' –∏–ª–∏ 'real'
const CHECK_INTERVAL_MS = Number(process.env.CHECK_INTERVAL_MS || 5000);

if (!token) {
  console.error('–û—à–∏–±–∫–∞: TELEGRAM_TOKEN –Ω–µ –∑–∞–¥–∞–Ω. –î–æ–±–∞–≤—å —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è Railway.');
  process.exit(1);
}

console.log('–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞ MODE =', MODE);

// –°–æ–∑–¥–∞—ë–º Telegram-–±–æ—Ç–∞
const bot = new TelegramBot(token, { polling: true });

// –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (userId -> {...})
const users = new Map();
// –∑–∞–ø–æ–º–∏–Ω–∞–µ–º, –∫–∞–∫–∏–µ —Å–¥–µ–ª–∫–∏ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ (userId:giftId)
const sentDeals = new Set();

// –û—Å–Ω–æ–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
const MAIN_KEYBOARD = {
  keyboard: [
    [{ text: 'üîç –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫' }, { text: '‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫' }],
    [{ text: 'üí∞ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É' }],
    [{ text: 'üéõ –§–∏–ª—å—Ç—Ä—ã' }],
  ],
  resize_keyboard: true,
};

// –æ—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –≥–∏—Ñ—Ç–æ–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function clearUserSentDeals(userId) {
  const prefix = `${userId}:`;
  for (const key of Array.from(sentDeals)) {
    if (key.startsWith(prefix)) {
      sentDeals.delete(key);
    }
  }
}

function getOrCreateUser(userId) {
  if (!users.has(userId)) {
    users.set(userId, {
      maxPriceTon: null,
      enabled: true, // –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤–∫–ª—é—á—ë–Ω
      state: null,   // —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–≤–æ–¥–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ü–µ–Ω—ã)
      filters: {
        gifts: [],      // –ø–æ–¥–∞—Ä–∫–∏ (Victory Medal, ...)
        models: [],     // –º–æ–¥–µ–ª–∏ (Genius, ...)
        backdrops: [],  // —Ñ–æ–Ω—ã (Black, ...)
      },
    });
  }
  return users.get(userId);
}

// =====================
// –ö–æ–º–∞–Ω–¥—ã
// =====================

bot.onText(/^\/start\b/, (msg) => {
  const chatId = msg.chat.id;
  getOrCreateUser(msg.from.id);

  const text =
    '–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω.\n\n' +
    `–†–µ–∂–∏–º: ${MODE === 'test' ? '–¢–ï–°–¢–û–í–´–ô (—Å–ª—É—á–∞–π–Ω—ã–µ —Ü–µ–Ω—ã)' : '–†–ï–ê–õ–¨–ù–´–ï –¶–ï–ù–´ —Å Portal'}\n\n` +
    '–ö–Ω–æ–ø–∫–∏ —Å–Ω–∏–∑—É:\n' +
    'üîç –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫ ‚Äî –≤–∫–ª—é—á–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥\n' +
    '‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫ ‚Äî –≤—ã–∫–ª—é—á–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥\n' +
    'üí∞ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É ‚Äî –∑–∞–¥–∞—Ç—å –º–∞–∫—Å–∏–º—É–º –≤ TON\n' +
    'üéõ –§–∏–ª—å—Ç—Ä—ã ‚Äî –≤—ã–±—Ä–∞—Ç—å –ø–æ–¥–∞—Ä–∫–∏/–º–æ–¥–µ–ª–∏/—Ñ–æ–Ω—ã';

  bot.sendMessage(chatId, text, { reply_markup: MAIN_KEYBOARD });
});

bot.onText(/^\/help\b/, (msg) => {
  const chatId = msg.chat.id;
  const text =
    '–ë–æ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç NFT‚Äë–ø–æ–¥–∞—Ä–∫–∏ Portal.\n\n' +
    '–ö–Ω–æ–ø–∫–∏:\n' +
    'üîç –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫ ‚Äî –Ω–∞—á–∞—Ç—å —Å–ª–∞—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –≥–∏—Ñ—Ç—ã\n' +
    '‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫ ‚Äî –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å\n' +
    'üí∞ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É ‚Äî –º–∞–∫—Å–∏–º—É–º –≤ TON\n' +
    'üéõ –§–∏–ª—å—Ç—Ä—ã ‚Äî –ø–æ–¥–∞—Ä–∫–∏ / –º–æ–¥–µ–ª–∏ / —Ñ–æ–Ω—ã\n\n' +
    '–ö–æ–º–∞–Ω–¥—ã:\n' +
    '/setmaxprice 0.5 ‚Äî –∑–∞–¥–∞—Ç—å —Ü–µ–Ω—É\n' +
    '/status ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏\n' +
    '/listgifts ‚Äî —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤\n' +
    '/listmodels ‚Äî —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –∏ —Ñ–æ–Ω–æ–≤';

  bot.sendMessage(chatId, text, { reply_markup: MAIN_KEYBOARD });
});

// /setmaxprice <—á–∏—Å–ª–æ>
bot.onText(/^\/setmaxprice\b(?:\s+(.+))?/, (msg, match) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  const arg = match[1];

  if (!arg) {
    bot.sendMessage(chatId, '–£–∫–∞–∂–∏ —Ü–µ–Ω—É –≤ TON.\n–ù–∞–ø—Ä–∏–º–µ—Ä:\n/setmaxprice 0.5');
    return;
  }

  const value = parseFloat(arg.replace(',', '.'));
  if (Number.isNaN(value) || value <= 0) {
    bot.sendMessage(chatId, '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ü–µ–Ω–∞. –í–≤–µ–¥–∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä: 0.3');
    return;
  }

  const user = getOrCreateUser(userId);
  user.maxPriceTon = value;
  clearUserSentDeals(userId);

  bot.sendMessage(
    chatId,
    `–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: ${value.toFixed(3)} TON.`,
    { reply_markup: MAIN_KEYBOARD }
  );
});

bot.onText(/^\/status\b/, (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  const user = getOrCreateUser(userId);

  let text = '–¢–≤–æ–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:\n';

  if (user.maxPriceTon) {
    text += `‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞: ${user.maxPriceTon.toFixed(3)} TON\n`;
  } else {
    text += '‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞: –Ω–µ –∑–∞–¥–∞–Ω–∞ (–∫–Ω–æ–ø–∫–∞ "üí∞ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É")\n';
  }

  text += `‚Ä¢ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: ${user.enabled ? '–≤–∫–ª—é—á—ë–Ω' : '–≤—ã–∫–ª—é—á–µ–Ω'}\n`;

  if (user.filters.gifts.length) {
    text += `‚Ä¢ –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–¥–∞—Ä–∫–∞–º: ${user.filters.gifts.join(', ')}\n`;
  } else {
    text += '‚Ä¢ –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–¥–∞—Ä–∫–∞–º: –Ω–µ—Ç\n';
  }

  if (user.filters.models.length) {
    text += `‚Ä¢ –§–∏–ª—å—Ç—Ä –ø–æ –º–æ–¥–µ–ª—è–º: ${user.filters.models.join(', ')}\n`;
  } else {
    text += '‚Ä¢ –§–∏–ª—å—Ç—Ä –ø–æ –º–æ–¥–µ–ª—è–º: –Ω–µ—Ç\n';
  }

  if (user.filters.backdrops.length) {
    text += `‚Ä¢ –§–∏–ª—å—Ç—Ä –ø–æ —Ñ–æ–Ω–∞–º: ${user.filters.backdrops.join(', ')}\n`;
  } else {
    text += '‚Ä¢ –§–∏–ª—å—Ç—Ä –ø–æ —Ñ–æ–Ω–∞–º: –Ω–µ—Ç\n';
  }

  text += `\n–†–µ–∂–∏–º: ${MODE === 'test' ? '–¢–ï–°–¢–û–í–´–ô (—Å–ª—É—á–∞–π–Ω—ã–µ —Ü–µ–Ω—ã)' : '–†–ï–ê–õ–¨–ù–´–ï –¶–ï–ù–´ (Portal)'}.\n`;

  bot.sendMessage(chatId, text, { reply_markup: MAIN_KEYBOARD });
});

// =====================
// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –¥–ª—è —Å–ø–∏—Å–∫–æ–≤
// =====================

async function getCurrentGifts() {
  try {
    return await fetchGifts();
  } catch (e) {
    console.error('getCurrentGifts error:', e);
    return [];
  }
}

function buildNameMapFromGifts(gifts) {
  const giftNames = new Map();
  const models = new Map();
  const backdrops = new Map();

  for (const g of gifts) {
    const base = (g.baseName || g.name || '').trim();
    if (base) {
      const k = base.toLowerCase();
      if (!giftNames.has(k)) giftNames.set(k, base);
    }

    const m = g.attrs?.model;
    if (m) {
      const k = m.toLowerCase();
      if (!models.has(k)) models.set(k, m);
    }

    const b = g.attrs?.backdrop;
    if (b) {
      const k = b.toLowerCase();
      if (!backdrops.has(k)) backdrops.set(k, b);
    }
  }

  return { giftNames, models, backdrops };
}

function buildInlineButtons(prefix, names) {
  const buttons = [];
  let row = [];
  for (const name of names) {
    row.push({
      text: name,
      callback_data: `${prefix}${name}`,
    });
    if (row.length === 2) {
      buttons.push(row);
      row = [];
    }
  }
  if (row.length) buttons.push(row);
  return buttons;
}

// =====================
// /listgifts –∏ /listmodels
// =====================

bot.onText(/^\/listgifts\b/, async (msg) => {
  const chatId = msg.chat.id;
  const gifts = await getCurrentGifts();
  if (!gifts.length) {
    bot.sendMessage(chatId, '–ü–æ–¥–∞—Ä–∫–æ–≤ —Å–µ–π—á–∞—Å –Ω–µ –Ω–∞–π–¥–µ–Ω–æ (–ø–æ —Ç–µ–∫—É—â–µ–º—É –∑–∞–ø—Ä–æ—Å—É Portal).');
    return;
  }

  const { giftNames } = buildNameMapFromGifts(gifts);
  if (!giftNames.size) {
    bot.sendMessage(chatId, '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–¥–µ–ª–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–¥–∞—Ä–∫–æ–≤.');
    return;
  }

  const lines = Array.from(giftNames.values())
    .sort()
    .map((n) => `- ${n}`);

  let text = '–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏ (–ø–æ —Ç–µ–∫—É—â–µ–º—É –∑–∞–ø—Ä–æ—Å—É Portal):\n' + lines.join('\n');
  if (text.length > 4000) text = text.slice(0, 3990) + '\n...';

  bot.sendMessage(chatId, text, { reply_markup: MAIN_KEYBOARD });
});

bot.onText(/^\/listmodels\b/, async (msg) => {
  const chatId = msg.chat.id;
  const gifts = await getCurrentGifts();
  if (!gifts.length) {
    bot.sendMessage(chatId, '–î–∞–Ω–Ω—ã–µ –ø–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã (–ø–æ —Ç–µ–∫—É—â–µ–º—É –∑–∞–ø—Ä–æ—Å—É Portal).');
    return;
  }

  const { giftNames, models, backdrops } = buildNameMapFromGifts(gifts);

  let text = '–ü–æ–¥–∞—Ä–∫–∏:\n';
  if (giftNames.size) {
    text += Array.from(giftNames.values())
      .sort()
      .map((n) => `- ${n}`)
      .join('\n');
  } else {
    text += '(–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö)\n';
  }

  text += '\n\n–ú–æ–¥–µ–ª–∏:\n';
  if (models.size) {
    text += Array.from(models.values())
      .sort()
      .map((n) => 